var key;var isSubscribed = false;var optinStatus = "disable";var optinType = 'default';var isAlternativeUrl = false;var host='https://app.truepush.com/';var websiteIcon = '5dc58207-55a9-443e-8bf7-2fbb46060efc.png';var websiteURL = 'www.journaldev.com';var cdnUrl = 'https://app.truepush.com/';var websiteKey='5c384f661d09e8513bdc898d';var webpushId = '';var enabledBrowsers = 'except_safari';var publicKey = 'BMCDbECM1bKZEfZ3pwjcu0WBvvLeNqwQyI426bH7lPF2WYGAna4dT9ciso40FHivMy9H05EPGNJhXM0Tp5ot5zQ';var browserInfo;var fromWordpress = false;var optinShowInterval = 5000;var canActivateSafari = false;var browserData = {"ua":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36","browser":{"name":"Chrome","version":"71.0.3578.98","major":"71"},"engine":{"name":"WebKit","version":"537.36"},"os":{"name":"Windows","version":"10"},"device":{},"cpu":{"architecture":"amd64"}};var welcomeNotification = null;;if(typeof Promise!== 'undefined'){loadStyle('https://app.truepush.com/optins/optins.css');}else{console.log("browser is not supported");}function LoadRemaining(){loadScripts(['https://app.truepush.com/optins/optins.js'], function(){setTimeout(function(){begin();},100)});}function loadScript(url, callback) {var script = document.createElement('script');script.type = 'text/javascript';script.src = url;script.onreadystatechange = callback;script.onload = callback;document.head.appendChild(script);}function loadStyle(url){var head = document.head;var link = document.createElement("link");link.type = "text/css";link.rel = "stylesheet";link.href = url;link.onload = function() {loadScripts(['https://app.truepush.com/browser-check.js','https://app.truepush.com/http.js','https://app.truepush.com/common-functions.js'],function(){isNotifAllowed().then(function(bdata){browserInfo = bdata;if(IsBrowserEnabled())LoadRemaining();else{console.log("not opted in this browser");}}).catch(function(e){try{document.getElementById('jklm-custom').style.display = "none"; }catch(e){}})});};head.appendChild(link);}function loadScripts(urls, callback) {var loadedCount = 0;var multiCallback = function() {loadedCount++;if (loadedCount >= urls.length) {callback.call(this, arguments);}};for (var i=0;i<urls.length;i++) {loadScript(urls[i], multiCallback);}}function  begin() {SendVisitRequest({visit: true,optinType: optinType});if(browserInfo && browserInfo.b != 'Safari'){key = urlB64ToUint8Array(publicKey);if ('serviceWorker' in navigator) {var url = "/sw.js?";var hash = "/sw.js?"+Math.floor(Date.now()/(10*1000));var testingUrl = "/sw.js?"+Math.floor(Date.now()/(10*1000));navigator.serviceWorker.register(hash).then(function(reg1) {if(Notification.permission === 'granted'){return subscribeUser(true);}navigator.serviceWorker.ready.then(function (reg) {reg.pushManager.getSubscription().then(function(sub) {if (sub === null) {if(!isAlternativeUrl){if(Notification.permission==='default' ){if(optinType != 'custom'){setTimeout(function(){if(CanShowOptin()){if(optinType != 'default' ){SendVisitRequest({optin : true,optinType: optinType});ShowOptin();optinStatus = "enable";}else {subscribeUser();}}},optinShowInterval);}}else if(Notification.permission==='granted' ){subscribeUser(true);}}else{if(Notification.permission == 'denied'){ShowMessage('block')}else{ShowMessage('request');subscribeUser();}}isSubscribed = false;} else {isSubscribed = true;if(isAlternativeUrl){ShowMessage('success')}var obj1 = {"subscription":sub,"userPlatformId":"5c384f661d09e8513bdc898d","isChrome": isChrome()};fetch('https://app.truepush.com/api/V1/upsertSubscriber',{method:'POST',headers :{'Content-Type':'application/json'},credentials: "include",body:JSON.stringify(obj1)}).then(function (res) {res.json().then(function (resp) {});},function (err) {console.log(err);});}}) .catch(function(err) {console.log('get subscription error: ', err);});;}).catch(function(err) {console.log('Service Worker ready failed: ', err);});}).catch(function(err) {console.log('Service Worker registration failed: ', err);});}}else if(canActivateSafari){if ('safari' in window && 'pushNotification' in window.safari) {var permissionData = window.safari.pushNotification.permission(webpushId);if (permissionData.permission === 'default') {if(optinType != 'custom'){if(!isAlternativeUrl){setTimeout(function(){if(optinType != 'default' ){SendVisitRequest({optin : true,optinType: optinType});ShowOptin();optinStatus = "enable";}else{subscriberUserSafari();}},optinShowInterval);}else{subscriberUserSafari();}}}else if(permissionData.permission === 'denied' && isAlternativeUrl){ShowMessage('block');}else if(permissionData.permission === 'granted' && isAlternativeUrl){ShowMessage("success");}}}else{console.log("safari browser is not yet activated.");}}function subscribeUser(skipCheck) {if(browserInfo && browserInfo.b === 'Safari'){subscriberUserSafari();return;}if(Notification && Notification.permission!='granted' || skipCheck){var hours = new Date(parseInt(localStorage.getItem('time'))).getHours();if(Date.now() < new Date(parseInt(localStorage.getItem('time'))).setSeconds(hours + 24) || 0){return;}if ('serviceWorker' in navigator) {navigator.serviceWorker.ready.then(function (reg) {try{SendVisitRequest({show: true,optinType: optinType});reg.pushManager.subscribe({userVisibleOnly: true,applicationServerKey: key}).then(function(sub) {if(welcomeNotification && !skipCheck)ShowWelcomeNotification(reg);if(optinStatus == 'enable')HideOptin();localStorage.setItem('permission','granted');if(isAlternativeUrl){ShowMessage("success");}var obj = {"subscription":sub,"userPlatformId":"5c384f661d09e8513bdc898d","isChrome": isChrome()};fetch('https://app.truepush.com/api/v1/upsertSubscriber',{method:'POST',headers :{'Content-Type':'application/json'},credentials: "include",body:JSON.stringify(obj)}).then(function (res) {res.json().then(function (resp) {SendVisitRequest({subscribed: true,optinType: optinType});});},function (err) {console.log(err);});}).catch(function(e) {localStorage.setItem('permission',Notification.permission);if(optinStatus == 'enable')HideOptin();if(Notification.permission === 'granted'){ReSubscribe();}if (Notification.permission === 'denied') {SendVisitRequest({block: true,optinType: optinType});navigator.serviceWorker.ready.then(function (reg) {reg.pushManager.getSubscription().then(function (sub) {});});} else if(Notification.permission === 'default') {if(browserInfo.b === 'Firefox'){createCookie("permission", "blocked");}SendVisitRequest({ignore: true,optinType: optinType});localStorage.setItem('time',Date.now()+'');}});}catch(e){alert(e)}});}}}function subscriberUserSafari(){if ('safari' in window && 'pushNotification' in window.safari) {var permissionData = window.safari.pushNotification.permission(webpushId);if (permissionData.permission === 'default') {if(isAlternativeUrl)ShowMessage('request');window.safari.pushNotification.requestPermission(host.slice(0,-1),webpushId,{platformId: websiteKey},checkSafariPermission);}};}function checkSafariPermission(){var permissionData = window.safari.pushNotification.permission(webpushId);if (permissionData.permission === 'denied') {SendVisitRequest({block: true,optinType: optinType});if(isAlternativeUrl){ShowMessage("block");}}else if (permissionData.permission === 'granted') {if(isAlternativeUrl)ShowMessage('success');}}function ShowMessage(type){var element1 = document.getElementById("successDiv");var element2 = document.getElementById("requestDiv");var element3 =  document.getElementById("blockDiv");element1.style.display="none";element2.style.display="none";element3.style.display="none";if(type === 'request'){element2.style.display = "block";}else if(type === 'success'){element1.style.display="block";setTimeout( function(){self.close();},5000)/*window.opener.ChangeSubscribeStatus("success") */}else if(type === 'block'){element3.style.display = "block";}}function ShowWelcomeNotification(reg){var nObj = welcomeNotification;var options = {};if(nObj.image)options.image = cdnUrl+"/campaign_images/"+ decodeHtml(nObj.image);if(nObj.icon)options.icon =cdnUrl+"/website_icons/"+ decodeHtml(nObj.icon);if(nObj.message)options.body = decodeHtml(nObj.message);reg.showNotification(decodeHtml(nObj.title), options)}function decodeHtml(html) {var txt = document.createElement("textarea");txt.innerHTML = html;return txt.value;}function createCookie(name, value) {var date = new Date();date.setTime(date.getTime()+(10*1000));var expires = "; expires="+date.toGMTString();document.cookie = name+"="+value+expires+"; path=/";}function CanShowOptin(){if(browserInfo.b === 'Firefox'){var match = document.cookie.match(new RegExp('(^| )permission=([^;]+)'));if (match) return false;return true;}return true;}function isChrome() {if(navigator && navigator.plugins){for (var i=0; i<navigator.plugins.length; i++)if (navigator.plugins[i].name == 'Chrome PDF Viewer') return true;return false;}return false;}function ReSubscribe(){navigator.serviceWorker.ready.then(function (reg) {reg.pushManager.getSubscription().then(function(sub) {if(sub){sub.unsubscribe();subscribeUser(true);}else{console.log("subscription is null")}}).catch(function(e) {console.log("error while getting ReSubscribe", e);});}).catch(function(e) {console.log("error while ready ReSubscribe", e);})}